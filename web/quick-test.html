<!DOCTYPE html>
<html>
<head>
    <title>Quick Fix Test</title>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
</head>
<body>
    <h1>Testing Task Processing Fix</h1>
    <button onclick="testFix()">Test String Conversion Fix</button>
    <div id="results"></div>

    <script type="module">
        // Mock the necessary functions for testing
        window.AppState = { activeSheet: 'Sheet1', dryRun: false };
        
        window.getWorksheet = () => ({});
        window.saveToHistory = () => {};
        window.renderSpreadsheetTable = () => {};
        window.showToast = (msg, type) => console.log(`Toast: ${msg} (${type})`);
        window.persistSnapshot = () => {};
        window.expandRefForCell = () => {};
        
        // Mock parseCellValue function
        window.parseCellValue = (value) => {
            if (value === '' || value === null || value === undefined) {
                return { t: 'z', v: null };
            }
            if (!isNaN(value) && value !== '') {
                return { t: 'n', v: parseFloat(value) };
            }
            return { t: 's', v: String(value) };
        };

        // Import the actual updateCell function
        import { updateCell } from './spreadsheet/grid-interactions.js';
        window.updateCell = updateCell;

        window.testFix = async function() {
            const results = document.getElementById('results');
            results.innerHTML = '<h2>Test Results:</h2>';
            
            try {
                // Test with different value types
                const testValues = [
                    { cell: 'A1', value: 'Hello', type: 'string' },
                    { cell: 'A2', value: 42, type: 'number' },
                    { cell: 'A3', value: true, type: 'boolean' },
                    { cell: 'A4', value: '=SUM(A1:A3)', type: 'formula' },
                    { cell: 'A5', value: 0, type: 'zero' }
                ];

                for (const test of testValues) {
                    try {
                        // Import and test the fix
                        const { applyEditsOrDryRun } = await import('./spreadsheet/operations.js');
                        
                        const mockResult = {
                            edits: [{
                                op: 'setCell',
                                cell: test.cell,
                                value: test.value
                            }]
                        };
                        
                        await applyEditsOrDryRun(mockResult);
                        results.innerHTML += `<p>✅ ${test.type} (${test.value}) - SUCCESS</p>`;
                        
                    } catch (error) {
                        results.innerHTML += `<p>❌ ${test.type} (${test.value}) - FAILED: ${error.message}</p>`;
                    }
                }
                
                results.innerHTML += '<h3>✅ All tests completed! The fix should be working.</h3>';
                
            } catch (error) {
                results.innerHTML += `<p>❌ Test setup failed: ${error.message}</p>`;
            }
        };
    </script>
</body>
</html>